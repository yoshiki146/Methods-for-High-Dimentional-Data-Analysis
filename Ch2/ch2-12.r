
#######################################################
#
#???????f?[?^???͂̕??@?F?t?^?i???q???X?j
#?q?v???O?????Fch2-12.r
#
#######################################################
rm(list=ls())
library(quantreg)
data(tuna, package="bayesm")
tau <- 0.05 #5\%???ʓ_
lambda <- 10 #???????p?????[?^
x <- as.matrix(cbind(1,tuna[,16:22],tuna[,9:15],log(tuna[,30]))) #?���?ϐ?
y <- log(tuna[,2]) #Star Kist 6 ?I???X?T?C?Y?̔????グ
n <- nrow(x)
p <- ncol(x)
fit <- rq.fit.lasso(x,y,tau=tau,lambda=lambda) #Lasso??????
lambda <- fit$lambda #?g?p???ꂽ???????p?????[?^?̒l
print(lambda)
beta <- trunc(10^10*fit$coefficients)/10^10 #???肳?ꂽ???A?W???̒l
print(beta) #???肳?ꂽ???A?W???̕\?? 
fit$coef

# compare with differing lambda
lambda <- 10^(seq(-3,2,len=20)) # lambda choises
cv.score <- rep(0,len=length(lambda)) # placeholcer
for(i in 1:length(lambda)){
  lam <- lambda[i]
  for(l in 1:n){
    x.cv <- x[-l,]
    y.cv <- as.vector(y[-l])
    fit <- rq.fit.lasso(x,y,tau=tau,lambda=lam) #Lasso??????
    b.est <- trunc(10^10*fit$coefficients)/10^10  #???A?W???̐????l
    
    pred <- sum(c(1,x[l,])*b.est) #?ړI?ϐ??̗\??
    er <- y[l]-pred
    cv.er <- (abs(er)+(2*tau-1)*er)/2
    cv.score[i] <- cv.score[i]+cv.er 
  }
}

#???????p?????[?^(????)??CV?X?R?A?i?c???j?̕\??
par(cex.lab=1.2)
par(cex.axis=1.2)
plot(log(lambda),cv.score,xlab="log(Regularization parameter)",ylab="CV.score",type="l",lwd=2) 
dev.copy2eps(file="Quantile-lasso095-CVplot.ps")

#?œK?Ȑ??????p?????[?^?̑I??
opt.lambda <- lambda[subset(1:length(lambda),cv.score==min(cv.score))] 

#?ŏI?I?Ȑ?????
fit <- rq.fit.lasso(x,y,tau=tau,lambda=opt.lambda) 
beta <- trunc(10^10*fit$coefficients)/10^10 #???肳?ꂽ???A?W???̒l
print(beta) #?ŏI?I?Ȑ????ʂ̕\??
