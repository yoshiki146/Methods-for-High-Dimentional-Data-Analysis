
#######################################################
#
#???????f?[?^???Í‚Ì•??@?F?t?^?i???q???X?j
#?q?v???O?????Fch1-02.r
#
#ch1-01.r?ğ–‘O?ÉÀs???Äƒf?[?^?Ì“Ç‚İ??İ‚ğ‚µ‚Ä‚????????B
#######################################################

libraryrm(list=ls())
setwd("Ch1")
source("ch1-01.r")
(quadprog)

m <- nol(R) #???Z???Y?Ì???
kappa <- 1.05 #?B?????é’´?ß??v??
n <- 60 #?????É—??p?????ß‹??f?[?^?ÌƒT?C?Y
Portfolio <- matrix(0,nrow=nrow(R),ncol=m) #?|?[?g?t?H???I
Risk <- rep(0,len=nrow(R)) #?|?[?g?t?H???I?Ì•??U?i???X?N?j

#???[?????O?É‚????|?[?g?t?H???I?Ì\?z
for(i in (n+1):(nrow(R))){

E <- as.matrix(cbind(1,X[(i-n):(i-1),]))
Z <- as.matrix(R[(i-n):(i-1),])
B <- solve(t(E)%*%E)%*%t(E)%*%Z
xt <- as.matrix(cbind(1,X[i,]),ncol=1)

r <- as.vector(1+xt%*%B/100) #???Ò’??ß??v??
S <- t(Z-E%*%B)%*%(Z-E%*%B)/n #???U?????U?s??
meanr <- mean(r)

d <- rep(0,m)
b <- c(1, meanr, rep(0,len=m))
D <- S
A <- cbind(rep(1,len=m),r,diag(1,m))
fit <- solve.QP(S,d,A,b,meq=2) #?ñŸŒv???@?É‚????|?[?g?t?H???I?g??
w <- fit$solution #???????z?ä—¦

Portfolio[i,] <- t(w)
Risk[i] <- t(w)%*%S%*%w

}

#?|?[?g?t?H???I?Ì}??

par(cex.lab=1.2)
par(cex.axis=1.2)
a <- (n+1):nrow(R)
b <- nrow(R):(n+1)
ss <- terrain.colors(m)

plot(c(n+1,nrow(R)),c(0,1),type="n",xlab="Months since Jan. 1927",ylab="")

xx <- c(a,b)
yy <- c(rep(0,len=nrow(R)-n),Portfolio[b,1])
polygon(xx, yy, col=ss[1], border="black",lwd=10^-4)
yy <- c(Portfolio[a,1],Portfolio[b,1]+Portfolio[b,2])
polygon(xx, yy, col=ss[2], border="black",lwd=10^-4)
for(i in 3:m){
yy <- c(Portfolio[a,1:(i-1)]%*%rep(1,len=i-1),Portfolio[b,1:i]%*%rep(1,len=i))
polygon(xx, yy, col=ss[i], border="black",lwd=10^-4)
}

dev.copy2eps(file="Portfolio.ps")

#?|?[?g?t?H???I???U?Ì}??

par(cex.lab=1.2)
par(cex.axis=1.2)
a <- (n+1):nrow(R)
plot(c(n+1,nrow(R)),c(0,max(Risk)),type="n",xlab="Months since Jan. 1927",ylab="")

xx <- c(a,b)
yy <- c(rep(0,len=nrow(R)-n),Portfolio[b,1])
polygon(xx, yy, col=ss[1], border="black",lwd=10^-4)

dev.copy2eps(file="PortfolioRisk.ps")

